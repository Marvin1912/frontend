<div class="session-container" (keydown)="onKeydown($event)">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p class="loading-text">Training wird vorbereitet...</p>
  </div>

  <!-- Main Session Content -->
  <div *ngIf="!isLoading && currentSession" class="session-content">

    <!-- Header with Timer and Progress -->
    <div class="session-header">
      <div class="progress-section">
        <div class="progress-info">
          <span class="problem-counter">Aufgabe {{ currentProblemNumber }} von {{ totalProblems }}</span>
          <span class="remaining-problems">{{ remainingProblems }} verbleibend</span>
        </div>
        <mat-progress-bar
          mode="determinate"
          [value]="getSessionProgress()"
          [color]="getProgressColor()">
        </mat-progress-bar>
      </div>

      <div class="timer-section" [class.time-warning]="isTimeRunningOut" *ngIf="sessionTimeLimit">
        <mat-icon class="timer-icon">timer</mat-icon>
        <span class="timer-text">{{ formatDetailedTime(timeRemaining) }}</span>
      </div>

      <div class="score-section">
        <div class="score-display">
          <mat-icon class="score-icon">star</mat-icon>
          <span class="score-text">{{ currentScore }}</span>
        </div>
        <div class="accuracy-display">
          <mat-icon class="accuracy-icon">check_circle</mat-icon>
          <span class="accuracy-text">{{ currentAccuracy.toFixed(1) }}%</span>
        </div>
      </div>
    </div>

    <!-- Session Started Content -->
    <div *ngIf="isSessionStarted && !isSessionCompleted" class="training-area">

      <!-- Problem Display -->
      <div class="problem-display">
        <mat-card class="problem-card" [class.correct-feedback]="showFeedback && lastAnswerCorrect" [class.incorrect-feedback]="showFeedback && !lastAnswerCorrect">
          <mat-card-content class="problem-content">
            <div class="problem-expression">
              {{ currentProblemDisplay }}
            </div>
            <div *ngIf="showFeedback" class="feedback-message">
              <ng-container *ngIf="lastAnswerCorrect">
                <mat-icon class="feedback-icon correct">check_circle</mat-icon>
                <span class="feedback-text correct">Richtig!</span>
              </ng-container>
              <ng-container *ngIf="!lastAnswerCorrect">
                <mat-icon class="feedback-icon incorrect">close</mat-icon>
                <span class="feedback-text incorrect">Falsch! Die richtige Antwort ist {{ currentProblem?.answer }}</span>
              </ng-container>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Answer Input Area -->
      <div class="answer-input-area" *ngIf="!showFeedback">
        <mat-card class="answer-card">
          <mat-card-content>
            <form [formGroup]="answerForm" (ngSubmit)="onSubmitAnswer()">
              <mat-form-field appearance="outline" class="answer-input-field">
                <mat-label>Ihre Antwort</mat-label>
                <input matInput type="number" formControlName="userAnswer" placeholder="0" autocomplete="off">
                <mat-icon matSuffix>calculator</mat-icon>
                <mat-error *ngIf="answerForm.get('userAnswer')?.hasError('required')">
                  Bitte geben Sie eine Antwort ein
                </mat-error>
                <mat-error *ngIf="answerForm.get('userAnswer')?.hasError('pattern')">
                  Bitte geben Sie eine gültige Zahl ein
                </mat-error>
              </mat-form-field>

              <div class="answer-buttons">
                <button mat-raised-button
                        type="submit"
                        color="primary"
                        [disabled]="!answerForm.valid"
                        class="submit-btn">
                  <mat-icon>check</mat-icon>
                  Antwort prüfen
                </button>
                <button mat-button
                        type="button"
                        (click)="answerForm.reset()"
                        class="clear-btn">
                  <mat-icon>clear</mat-icon>
                  Löschen
                </button>
              </div>
            </form>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- On-screen Number Pad for Mobile -->
      <div class="number-pad" *ngIf="!showFeedback">
        <div class="pad-row">
          <button mat-button class="pad-btn" (click)="appendNumber('7')">7</button>
          <button mat-button class="pad-btn" (click)="appendNumber('8')">8</button>
          <button mat-button class="pad-btn" (click)="appendNumber('9')">9</button>
        </div>
        <div class="pad-row">
          <button mat-button class="pad-btn" (click)="appendNumber('4')">4</button>
          <button mat-button class="pad-btn" (click)="appendNumber('5')">5</button>
          <button mat-button class="pad-btn" (click)="appendNumber('6')">6</button>
        </div>
        <div class="pad-row">
          <button mat-button class="pad-btn" (click)="appendNumber('1')">1</button>
          <button mat-button class="pad-btn" (click)="appendNumber('2')">2</button>
          <button mat-button class="pad-btn" (click)="appendNumber('3')">3</button>
        </div>
        <div class="pad-row">
          <button mat-button class="pad-btn negative" (click)="toggleNegative()">+/-</button>
          <button mat-button class="pad-btn" (click)="appendNumber('0')">0</button>
          <button mat-button class="pad-btn" (click)="backspace()">
            <mat-icon>backspace</mat-icon>
          </button>
        </div>
      </div>

      <!-- Session Control Buttons -->
      <div class="session-controls">
        <button mat-button
                color="warn"
                (click)="endSession()"
                class="control-btn">
          <mat-icon>stop</mat-icon>
          Beenden
        </button>

        <button mat-button
                (click)="skipProblem()"
                class="control-btn">
          <mat-icon>skip_next</mat-icon>
          Überspringen
        </button>

        <button mat-button
                *ngIf="!isPaused"
                (click)="pauseSession()"
                class="control-btn">
          <mat-icon>pause</mat-icon>
          Pause
        </button>

        <button mat-raised-button
                *ngIf="isPaused"
                color="primary"
                (click)="resumeSession()"
                class="control-btn">
          <mat-icon>play_arrow</mat-icon>
          Fortsetzen
        </button>
      </div>
    </div>

    <!-- Session Completed -->
    <div *ngIf="isSessionCompleted" class="session-completed">
      <mat-card class="completion-card">
        <mat-card-content class="completion-content">
          <mat-icon class="completion-icon">emoji_events</mat-icon>
          <h2 class="completion-title">Training abgeschlossen!</h2>

          <div class="completion-stats">
            <div class="stat-item">
              <span class="stat-label">Endpunktzahl</span>
              <span class="stat-value">{{ currentScore }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Genauigkeit</span>
              <span class="stat-value">{{ currentAccuracy.toFixed(1) }}%</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Zeit</span>
              <span class="stat-value">{{ formatDetailedTime(timeElapsed) }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Richtige Antworten</span>
              <span class="stat-value">{{ currentSession.correctAnswers }}/{{ totalProblems }}</span>
            </div>
          </div>

          <div class="completion-actions">
            <button mat-raised-button color="primary" (click)="restartTraining()">
              <mat-icon>refresh</mat-icon>
              Neu starten
            </button>
            <button mat-button (click)="viewResults()">
              <mat-icon>list</mat-icon>
              Ergebnisse ansehen
            </button>
            <button mat-button (click)="goToMain()">
              <mat-icon>home</mat-icon>
              Zurück zum Menü
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Paused Overlay -->
    <div *ngIf="isPaused" class="paused-overlay">
      <mat-card class="paused-card">
        <mat-card-content class="paused-content">
          <mat-icon class="paused-icon">pause_circle</mat-icon>
          <h3 class="paused-title">Training pausiert</h3>
          <p class="paused-text">Ihr Fortschritt wird automatisch gespeichert.</p>
          <button mat-raised-button color="primary" (click)="resumeSession()">
            <mat-icon>play_arrow</mat-icon>
            Fortsetzen
          </button>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>